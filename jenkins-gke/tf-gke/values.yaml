# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

master:
  tag: "2.300"
  containerEnv:
    - name: PROJECT_ID
      valueFrom:
        secretKeyRef:
            name: jenkins-k8s-config
            key: project_id
    - name: GITHUB_REPO
      valueFrom:
        secretKeyRef:
            name: github-secrets
            key: github_repo
    - name: GITHUB_USERNAME
      valueFrom:
        secretKeyRef:
            name: github-secrets
            key: github_username
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
            name: github-secrets
            key: github_token
    - name: jenkins_tf_ksa
      valueFrom:
        secretKeyRef:
            name: jenkins-k8s-config
            key: jenkins_tf_ksa
  servicePort: 80
  serviceType: LoadBalancer
  installPlugins:
      - blueocean-dashboard:1.24.7
      - checks-api:1.7.0
      - pipeline-stage-view:2.19
      - ssh-credentials:1.19
      - popper2-api:2.5.4-2
      - structs:1.23
      - blueocean-core-js:1.24.7
      - momentjs:1.1.1
      - blueocean-personalization:1.24.7
      - sshd:3.0.3
      - git-client:3.7.2
      - workflow-durable-task-step:2.39
      - workflow-cps-global-lib:2.21
      - popper-api:1.16.1-2
      - workflow-basic-steps:2.23
      - pipeline-graph-analysis:1.11
      - blueocean-pipeline-editor:1.24.7
      - workflow-aggregator:2.6
      - plain-credentials:1.7
      - kubernetes-credentials:0.9.0
      - favorite:2.3.3
      - blueocean-i18n:1.24.7
      - workflow-support:3.8
      - github:1.33.1
      - configuration-as-code:1.51
      - display-url-api:2.3.5
      - blueocean-config:1.24.7
      - jenkins-design-language:1.24.7
      - bootstrap4-api:4.6.0-3
      - bouncycastle-api:2.20
      - durable-task:1.37
      - blueocean-git-pipeline:1.24.7
      - font-awesome-api:5.15.3-3
      - caffeine-api:2.9.1-23.v51c4e2c879c8
      - jackson2-api:2.12.3
      - htmlpublisher:1.25
      - workflow-api:2.46
      - pipeline-stage-step:2.5
      - git:4.7.2
      - workflow-job:2.41
      - blueocean-pipeline-scm-api:1.24.7
      - pipeline-stage-tags-metadata:1.8.5
      - jira:3.5
      - matrix-project:1.19
      - jsch:0.1.55.2
      - lockable-resources:2.11
      - variant:1.4
      - git-server:1.9
      - cloudbees-bitbucket-branch-source:2.9.9
      - trilead-api:1.0.13
      - scm-api:2.6.4
      - docker-workflow:1.26
      - pubsub-light:1.16
      - jdk-tool:1.4
      - branch-api:2.6.4
      - plugin-util-api:2.3.0
      - authentication-tokens:1.4
      - handlebars:3.0.8
      - pipeline-model-extensions:1.8.5
      - token-macro:2.15
      - pipeline-rest-api:2.19
      - blueocean-display-url:2.4.1
      - jjwt-api:0.11.2-9.c8b45b8bb173
      - mailer:1.34
      - blueocean-autofavorite:1.2.4
      - blueocean-commons:1.24.7
      - blueocean:1.24.7
      - command-launcher:1.6
      - blueocean-rest:1.24.7
      - kubernetes:1.30.0
      - apache-httpcomponents-client-4-api:4.5.13-1.0
      - cloudbees-folder:6.15
      - job-dsl:1.77
      - blueocean-bitbucket-pipeline:1.24.7
      - docker-commons:1.17
      - bootstrap5-api:5.0.1-2
      - blueocean-jira:1.24.7
      - pipeline-milestone-step:1.3.2
      - blueocean-pipeline-api-impl:1.24.7
      - blueocean-github-pipeline:1.24.7
      - pipeline-model-api:1.8.5
      - pipeline-model-definition:1.8.5
      - echarts-api:5.1.2-2
      - docker-custom-build-environment:1.7.3
      - handy-uri-templates-2-api:2.1.8-1.0
      - kubernetes-client-api:5.4.1
      - github-branch-source:2.11.1
      - blueocean-jwt:1.24.7
      - pipeline-input-step:2.12
      - github-api:1.123
      - junit:1.51
      - credentials-binding:1.26
      - workflow-scm-step:2.13
      - pipeline-build-step:2.13
      - ace-editor:1.1
      - blueocean-web:1.24.7
      - workflow-step-api:2.23
      - sse-gateway:1.24
      - credentials:2.5
      - okhttp-api:3.14.9
      - snakeyaml-api:1.29.1
      - blueocean-rest-impl:1.24.7
      - metrics:4.0.2.8
      - blueocean-events:1.24.7
      - workflow-cps:2.92
      - jquery3-api:3.6.0-1
      - script-security:1.77
      - workflow-multibranch:2.26
  JCasC:
    enabled: true
    configScripts:
        cloud: |
            jenkins:
                clouds:
                    - kubernetes:
                        name: "gke-executors"
                        serverUrl: "https://kubernetes.default"
                        jenkinsTunnel: "jenkins-agent:50000"
                        jenkinsUrl: "http://jenkins:80"
                        skipTlsVerify: true
                        namespace: "default"
                        templates:
                            - name: "jenkins-jnlp"
                              namespace: "default"
                              nodeUsageMode: NORMAL
                              label: "jnlp-exec"
                              containers:
                                - name: "jnlp"
                                  image: "jenkins/jnlp-slave"
                                  alwaysPullImage: false
                                  workingDir: "/home/jenkins/agent"
                                  ttyEnabled: true
                                  command: ""
                                  args: ""
                                  resourceRequestCpu: "500m"
                                  resourceLimitCpu: "1000m"
                                  resourceRequestMemory: "1Gi"
                                  resourceLimitMemory: "2Gi"
                              volumes:
                                - emptyDirVolume:
                                    memory: false
                                    mountPath: "/tmp"
                              idleMinutes: "1"
                              activeDeadlineSeconds: "120"
                              slaveConnectTimeout: "1000"
                            - name: "terraform"
                              namespace: "default"
                              nodeUsageMode: NORMAL
                              serviceAccount: ${jenkins_tf_ksa}
                              label: "terraform-exec"
                              containers:
                                - name: "terraform"
                                  image: "hashicorp/terraform:1.0.7"
                                  alwaysPullImage: false
                                  workingDir: "/home/jenkins/agent"
                                  ttyEnabled: true
                                  command: "/bin/sh -c"
                                  args: "cat"
                                  resourceRequestCpu: "100m"
                                  resourceLimitCpu: "500m"
                                  resourceRequestMemory: "500Mi"
                                  resourceLimitMemory: "1Gi"
                              volumes:
                                - emptyDirVolume:
                                    memory: false
                                    mountPath: "/tmp"
                              podRetention: "never"
                              activeDeadlineSeconds: "300"
                              slaveConnectTimeout: "1000"
        credentials: |
            credentials:
                system:
                    domainCredentials:
                    - credentials:
                        - usernamePassword:
                            scope: GLOBAL
                            id: "github-token"
                            username: ${GITHUB_USERNAME}
                            password: ${GITHUB_TOKEN}
                            description: "Github personal token"
                        - secretText
                            scope: GLOBAL
                            id: "terraform-auth"
                            secret: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAic3RhYmxlLXNwbGljZXItMzI2MTAyIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiYzUxMTM2MzAwZmYxNzMzNTNlODAzYmE5MWEzNmQ2ZDM3M2JmMmMwYSIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDUmpvNFhIRDJORjhFNlxueFVpNnNBSkQ2RkJORkYxbkxsT2RkczhHT0FrZVNnQXZvdTFsMlc2ajN6ZGpBd0doeHZOc0pHZHVxNGsrK3VuRlxueXpZSUZWNE1wdmoyVEJCVmdQbHRjcE96SHFGU1p5WFhZeUM1RmR1TGxjUVhSbnY5cEI2MmNBVDdYdE1yQm9YeVxuNjE0T0tvR09JeEo1NTBLSC9Wa2xlenhXazZVdUc5dm41TmYyWWRhNXdMcGREcndmKzZ1TU9rYmZqeHlkVkF2eFxudWpTcW5CRXkwV3d0UHN1R3NXQ2xKWDdPSHBTZU82YVhyMUxNMldYTHdCYmYzLzRoclhRUGp0dnlNY0xYWnVsSlxuYTNWY2dqcnVaK0RWSEljQmFiR3dSb1paWWZHWWxuVE5QdmlFcVhBeXFNZGYvdE1xV1dKVFJMczNjeEdzZG42ZVxuWjJPZkNFUGxBZ01CQUFFQ2dnRUFEZUJNOS9PTGc2Q2szVzB5MklkUWcvaEk5WHd3UmxhaWhvT3R5MDQ2d2s0MFxuTTlaZ3N1RzJYRDE2cW4vK0h4WFlIWEpnQU9zdDk1alVnZlIwTjNPUUJuMUJoVHR0b0RVZU1qcW16WC9wU2JHSFxuS0VBdFBhL1JnUDViVmd1MFpOTUpVWU9lMmZicGd6UEpQOFlEN3E1TE1RbHphTGNzL3NsZWZ3WC9VOUtaLytublxucWw3RzQ5azQ4NEpia1c4bFkzSlVjSUpWcjBDZFJCenlNbmFOZDE5UkxoSXAzRlJRTmUxazQ4bnY2Qk1CWnZSZFxuQXpsMC9QM2RjaHI4OU91N3c1dkpaY29XNTRBVk53T2VVRnluUE56Q0trN1FEQkdpUjUzN1BCcjVqRHZKem9VWFxueEIwcndTZnRVU3o0WWJkVUtnL04zUEVQVkd2bk8zanBrZTViY0ZpKzBRS0JnUURIM0JmS2h4M1ROYURDQ3V2eVxuQ0d6STJTWWg3NTJYaENKU2s0V1RpYlhkbHBSeXpKQ1J5UzJ3c1RDWVMyRWVEM1lTeEpWUGFxRi9YM1pHSmU2S1xuSTFpbVJCbXpNMXMyMjk4QUlaY1BXcVZJQzFtQWg2R3E0ZW5PWXJqNWdzeHFYNzJiZE8rc0JjNjZPNDlISXp0cVxuQ3RTM3piR0M2WmR3ZmVSZGQ0R2hQaWxMOFFLQmdRQzZjWXNzeG5IeHc3bThIZkllWWk5Skx4a1lJNndMNVdJYVxuUWFxcm1jTmNWV09WM0V0VTB6SXM4RjVDVGMzbnUwcEx4dlF2VDRvMTc0c2R4ZGxLZU5mNyt2MG9HMDd4T2loTFxuQVF4bGlSSFY5MTdMaWRhcmhFYkpFTGVpbTVaUXVTZERVVk4rYml1UXVhZ011MjJhcW9RZ1V3a3ZkRkE4eWVQU1xuT0hLcW9xczdOUUtCZ0F3WU42QmIrT1FWTkx0SmFlbmx0SithOUlITlBGNDA4dGJJY3FieENINTJaRmxtSThHT1xueVNNT05nQ2hYeWt3aWxhc2F0UzVnVGh5RUhoQ1IyTTRyRjZ6ZEZLeDR1MDQ5US9PK0pOSFN3VkhHbzE2cDcvdFxubC9hVFp0cENuaGc1M3dHUFhBbXUrRW13M1FUVER2OWwxR1dqSHdEckhlMEMwVlVPckZ1VHBYQWhBb0dBQndrTFxuMEdlNG12L2d2VmwvN21lVUV6WGt3NFZ0RTVIWFR0aFZnVjR2QWdmeTF3L1dBK0JvVDB2T3NyL08ya1MxL0FBSVxuN05RYWlnaDgvbVdkMm5LTzYrSS90VWk2aE4zRjhYYWJxaVV1K0J6NmhjR3d5UTRYd2JTUXlXRUhuZ291a2hxNlxuaE5YUmJRZWtjTDZOMXoxQitScEpDWEpoS0xvUmo3Z3prMzdKNlZVQ2dZRUFsUUlRQkljTEluMkcweGZXMkhrSVxuNlAzanNidDJzOGplcTFnamZ4ZnJ4MUF0bUhsUTZQT0crZk1KTVd0MSt3VE50d0JEdlk2SnROc1Q2d2ZWdTErWlxucFk0a2ZGMnFlZ3JERVozaVFZTzFZc3BmMmhTUERZdFBWU2JmRnYyM1ptZGI4U3B5ajV1SVlXbVhteXZmc2hkR1xuc2JoaHlpcmxaMVJmUTVyWHlLWXM0VFk9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAibm9ucHJvZG1hY2hpbmV1c2VyQHN0YWJsZS1zcGxpY2VyLTMyNjEwMi5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMDU3NTQwMDM4OTcyMDg3MTczNjAiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L25vbnByb2RtYWNoaW5ldXNlciU0MHN0YWJsZS1zcGxpY2VyLTMyNjEwMi5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
                            description: "Terraform auth"
        init-jobs: |
            jobs:
              - script: >
                    multibranchPipelineJob('terraform-jenkins-create-demo') {
                        factory {
                        workflowBranchProjectFactory {
                            scriptPath('example-pipelines/environments/Jenkinsfile')
                        }
                        }
                        branchSources {
                        github {
                            id('12312313')
                            scanCredentialsId('github-token')
                            repoOwner("${GITHUB_USERNAME}")
                            repository("https://github.com/mjkong/solutions-terraform-jenkins-gitops")
                            buildOriginBranch(true)
                            buildOriginPRMerge(true)
                            includes("dev prod PR*")
                        }
                        }
                        orphanedItemStrategy {
                        discardOldItems {
                            numToKeep(10)
                        }
                        }
                        triggers {
                        periodic(1)
                        }
                    }
